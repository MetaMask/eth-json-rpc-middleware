{"version":3,"file":"cache.js","sourceRoot":"","sources":["../../src/utils/cache.ts"],"names":[],"mappings":"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","sourcesContent":["import stringify from 'json-stable-stringify';\nimport type { Payload } from '../types';\n\nexport function cacheIdentifierForPayload(\n  payload: Payload,\n  skipBlockRef?: boolean,\n): string | null {\n  const simpleParams: string[] = skipBlockRef\n    ? paramsWithoutBlockTag(payload)\n    : payload.params ?? [];\n  if (canCache(payload)) {\n    return `${payload.method}:${stringify(simpleParams)}`;\n  }\n  return null;\n}\n\nexport function canCache(payload: Payload): boolean {\n  return cacheTypeForPayload(payload) !== 'never';\n}\n\nexport function blockTagForPayload(payload: Payload): string | undefined {\n  if (!payload.params) {\n    return undefined;\n  }\n  const index: number | undefined = blockTagParamIndex(payload);\n\n  // Block tag param not passed.\n  if (index === undefined || index >= payload.params.length) {\n    return undefined;\n  }\n\n  return payload.params[index];\n}\n\nexport function paramsWithoutBlockTag(payload: Payload): string[] {\n  if (!payload.params) {\n    return [];\n  }\n  const index: number | undefined = blockTagParamIndex(payload);\n\n  // Block tag param not passed.\n  if (index === undefined || index >= payload.params.length) {\n    return payload.params;\n  }\n\n  // eth_getBlockByNumber has the block tag first, then the optional includeTx? param\n  if (payload.method === 'eth_getBlockByNumber') {\n    return payload.params.slice(1);\n  }\n  return payload.params.slice(0, index);\n}\n\nexport function blockTagParamIndex(payload: Payload): number | undefined {\n  switch (payload.method) {\n    // blockTag is at index 2\n    case 'eth_getStorageAt':\n      return 2;\n    // blockTag is at index 1\n    case 'eth_getBalance':\n    case 'eth_getCode':\n    case 'eth_getTransactionCount':\n    case 'eth_call':\n      return 1;\n    // blockTag is at index 0\n    case 'eth_getBlockByNumber':\n      return 0;\n    // there is no blockTag\n    default:\n      return undefined;\n  }\n}\n\nexport function cacheTypeForPayload(payload: Payload): string {\n  switch (payload.method) {\n    // cache permanently\n    case 'web3_clientVersion':\n    case 'web3_sha3':\n    case 'eth_protocolVersion':\n    case 'eth_getBlockTransactionCountByHash':\n    case 'eth_getUncleCountByBlockHash':\n    case 'eth_getCode':\n    case 'eth_getBlockByHash':\n    case 'eth_getTransactionByHash':\n    case 'eth_getTransactionByBlockHashAndIndex':\n    case 'eth_getTransactionReceipt':\n    case 'eth_getUncleByBlockHashAndIndex':\n    case 'eth_getCompilers':\n    case 'eth_compileLLL':\n    case 'eth_compileSolidity':\n    case 'eth_compileSerpent':\n    case 'shh_version':\n    case 'test_permaCache':\n      return 'perma';\n\n    // cache until fork\n    case 'eth_getBlockByNumber':\n    case 'eth_getBlockTransactionCountByNumber':\n    case 'eth_getUncleCountByBlockNumber':\n    case 'eth_getTransactionByBlockNumberAndIndex':\n    case 'eth_getUncleByBlockNumberAndIndex':\n    case 'test_forkCache':\n      return 'fork';\n\n    // cache for block\n    case 'eth_gasPrice':\n    case 'eth_blockNumber':\n    case 'eth_getBalance':\n    case 'eth_getStorageAt':\n    case 'eth_getTransactionCount':\n    case 'eth_call':\n    case 'eth_estimateGas':\n    case 'eth_getFilterLogs':\n    case 'eth_getLogs':\n    case 'test_blockCache':\n      return 'block';\n\n    // never cache\n    default:\n      return 'never';\n  }\n}\n"]}